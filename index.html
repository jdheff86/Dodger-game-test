<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>Dodger ‚Äî Leaderboard + Accounts + Power-Ups</title>
<style>
  :root { --bg:#0c0f14; --fg:#e9efff; --accent:#58a6ff; --danger:#ff6b6b; --muted:#8a94a6; --good:#4ade80; --gold:#ffd166; }
  * { box-sizing:border-box; }
  html, body { margin:0; height:100%; background:var(--bg); color:var(--fg);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; -webkit-font-smoothing:antialiased; -webkit-tap-highlight-color:transparent; }
  body { overflow:hidden; touch-action:none; -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }
  canvas { display:block; width:100%; height:100%; }

  .safe { padding-top: env(safe-area-inset-top); }
  header {
    position:absolute; top:0; left:0; right:0; z-index:8; display:flex; flex-direction:column;
    padding:8px 10px; gap:6px; pointer-events:none;
  }

  /* üîí Two fixed-height rows that never wrap */
  .topbar, .toolbar {
    display:flex; align-items:center; gap:8px; height:44px; flex-wrap:nowrap;
  }
  .topbar { justify-content:space-between; }
  .toolbar { /* left + right each take half; keeps row locked */
    justify-content:space-between;
  }
  .left, .right { display:flex; gap:8px; align-items:center; min-width:0; }
  .toolbar .left { flex:1; min-width:0; }
  .toolbar .right { flex:1; justify-content:flex-end; min-width:0; }

  .hud, .btn, #userChip, #coinChip {
    pointer-events:auto; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);
    border-radius:12px; padding:6px 10px; white-space:nowrap; height:34px; display:flex; align-items:center;
  }
  .hud { gap:8px; }
  .btn { font-weight:700; }
  .btn:active { transform: translateY(1px); }

  /* üö´ Numbers won‚Äôt change width anymore */
  #score,#best,#ammo,#lives{
    display:inline-block; min-width:4.5ch; text-align:right; font-variant-numeric:tabular-nums;
  }

  #userChip { background:rgba(88,166,255,0.18); border-color:rgba(88,166,255,0.4);
    max-width:52vw; overflow:hidden; text-overflow:ellipsis;
  }

  /* Coin chip in header */
  #coinChip { gap:6px; background:rgba(255,213,95,0.12); border-color:rgba(255,213,95,0.35); }
  #coinChip svg { width:18px; height:18px; flex:0 0 auto; }
  #coinCount { font-variant-numeric:tabular-nums; min-width:2.5ch; text-align:right; }

  .controls {
    position:absolute; left:0; right:0; bottom:0; z-index:6; display:flex; justify-content:space-between; gap:12px; padding:14px; pointer-events:none;
  }
  .pad { flex:1; min-height:92px; border-radius:16px; pointer-events:auto;
    background:linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
    border:1px solid rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; }
  .pad span { font-size:28px; filter: drop-shadow(0 2px 0 rgba(0,0,0,0.35)); }
  .pad.fire { flex:0.9; }
  .ammo { color:var(--good); font-variant-numeric:tabular-nums; }

  #abilities { position:absolute; left:0; right:0; bottom:110px; display:flex; justify-content:center; z-index:6; pointer-events:none; }
  #shrinkBtn { pointer-events:auto; display:flex; align-items:center; gap:8px; }
  #shrinkCount { min-width:1.6em; text-align:center; }

  .overlay {
    position:absolute; inset:0; z-index:7; display:flex; align-items:center; justify-content:center;
    background: radial-gradient(1200px 800px at 50% 40%, rgba(88,166,255,0.12), rgba(12,15,20,0.92) 60%); text-align:center; padding:24px;
  }
  .card { max-width:560px; width:92%; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.14); border-radius:18px; padding:18px; backdrop-filter:blur(10px); }
  .title { font-size:26px; font-weight:800; margin:4px 0 10px; }
  .subtitle { color:var(--muted); margin-bottom:14px; }
  .go { margin-top:12px; width:100%; padding:12px 14px; font-weight:800; font-size:18px; border-radius:14px; border:none; color:#0b1220; background:var(--accent); }
  .muted { color:var(--muted); font-size:13px; margin-top:8px; }

  .modal { position:absolute; inset:0; z-index:12; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.55); padding:18px; }
  .panel { width:min(520px,92%); background:#121826; border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:16px; position:relative; }
  .panel h2 { margin:4px 0 12px; font-size:20px; }
  .grid { display:grid; gap:10px; }
  .grid input { width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.15); background:#0f141f; color:var(--fg); }
  .actions { display:flex; gap:10px; margin-top:8px; flex-wrap:wrap; }
  .btn2 { flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:var(--fg); font-weight:700; }
  .btn2.primary { background:var(--accent); color:#0b1220; border-color:transparent; }
  .x { position:absolute; top:10px; right:12px; background:transparent; border:none; color:var(--muted); font-size:22px; }
</style>
</head>
<body class="safe">
<canvas id="game" aria-label="Dodger game area"></canvas>

<header class="safe">
  <!-- Row 1: HUD (locked) -->
  <div class="topbar">
    <div class="left">
      <div class="hud"><strong>Score:</strong><span id="score">0</span></div>
      <div class="hud"><strong>Best:</strong><span id="best">0</span></div>
      <div class="hud"><strong>Ammo:</strong><span id="ammo" class="ammo">0</span></div>
      <div class="hud"><strong>Lives:</strong><span id="lives" class="ammo">0</span></div>
    </div>
    <div class="right"></div>
  </div>

  <!-- Row 2: account + buttons (locked) -->
  <div class="toolbar">
    <div class="left">
      <div id="userChip">Connecting‚Ä¶</div>
      <div id="coinChip" title="Coins">
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <defs>
            <radialGradient id="cg" cx="40%" cy="35%" r="65%">
              <stop offset="0%" stop-color="#ffe38a"/>
              <stop offset="55%" stop-color="#f5c240"/>
              <stop offset="100%" stop-color="#c68a12"/>
            </radialGradient>
          </defs>
          <circle cx="32" cy="32" r="22" fill="url(#cg)"/>
          <circle cx="32" cy="32" r="22" fill="none" stroke="#000" stroke-opacity=".25" stroke-width="2"/>
          <g fill="#000" fill-opacity=".28">
            <circle cx="32" cy="10" r="2"/><circle cx="45" cy="14" r="2"/><circle cx="52" cy="26" r="2"/>
            <circle cx="52" cy="38" r="2"/><circle cx="45" cy="50" r="2"/><circle cx="32" cy="54" r="2"/>
            <circle cx="19" cy="50" r="2"/><circle cx="12" cy="38" r="2"/><circle cx="12" cy="26" r="2"/><circle cx="19" cy="14" r="2"/>
          </g>
          <circle cx="32" cy="32" r="13" fill="#000" fill-opacity=".15"/>
          <text x="32" y="38" text-anchor="middle" font-size="18" font-weight="800" fill="#2b1900">D</text>
        </svg>
        <span id="coinCount">0</span>
      </div>
    </div>
    <div class="right">
      <button class="btn" id="lbBtn">Leaderboard</button>
      <button class="btn" id="nameBtn">Set name</button>
      <button class="btn" id="authBtn">Account</button>
      <button class="btn" id="pauseBtn" aria-label="Pause or resume">Pause</button>
    </div>
  </div>
</header>

<!-- Ability bar -->
<div id="abilities">
  <button id="shrinkBtn" class="btn">‚úÇ Shrink <span id="shrinkCount" class="ammo">0</span></button>
</div>

<!-- Controls -->
<div class="controls">
  <div class="pad" id="leftPad"><span>‚üµ</span></div>
  <div class="pad fire" id="firePad"><span>üî´ FIRE</span></div>
  <div class="pad" id="rightPad"><span>‚ü∂</span></div>
</div>

<!-- Start overlay -->
<div class="overlay" id="overlay">
  <div class="card">
    <div class="title">DODGER</div>
    <div class="subtitle">Avoid blocks. Power-ups: üî´ Blaster, ‚úÇ Shrink, üõ° Shield, üêå Slow, üß≤ Magnet, ‚ù§Ô∏è Life.</div>
    <button class="go" id="startBtn">Start</button>
    <div class="muted">Tip: Add to Home Screen on iPhone for full-screen play.</div>
  </div>
</div>

<!-- Name modal -->
<div class="modal" id="nameModal">
  <div class="panel">
    <button class="x" id="nameClose">√ó</button>
    <h2>Set display name</h2>
    <div class="grid"><input id="displayName" type="text" maxlength="24" placeholder="e.g., JohnH"></div>
    <div class="actions">
      <button class="btn2" id="cancelName">Cancel</button>
      <button class="btn2 primary" id="saveName">Save</button>
    </div>
    <div class="muted">Used on the global leaderboard.</div>
  </div>
</div>

<!-- Leaderboard modal -->
<div class="modal" id="lbModal">
  <div class="panel">
    <button class="x" id="lbClose">√ó</button>
    <h2>Global Leaderboard (Top 20)</h2>
    <table id="lbTable" style="width:100%; border-collapse:collapse;">
      <thead><tr><th style="text-align:left;">#</th><th style="text-align:left;">Name</th><th>Score</th><th>When</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="muted">Finish a run to submit your score.</div>
  </div>
</div>

<!-- Account modal -->
<div class="modal" id="authModal">
  <div class="panel">
    <button class="x" id="authClose">√ó</button>
    <h2>Account</h2>
    <div id="authMsg" class="muted" style="margin-bottom:8px;"></div>
    <div class="grid">
      <input id="authEmail" type="email" placeholder="Email">
      <input id="authPass" type="password" placeholder="Password (min 6)">
    </div>
    <div class="actions">
      <button class="btn2" id="authSignin">Sign in</button>
      <button class="btn2 primary" id="authSignup">Create account</button>
      <button class="btn2" id="authSignout">Sign out</button>
    </div>
  </div>
</div>

<!-- Firebase + game scripts (same as your working version) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth, signInAnonymously, onAuthStateChanged,
    signInWithEmailAndPassword, createUserWithEmailAndPassword,
    updateProfile, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp,
    doc, setDoc, getDoc, updateDoc, increment
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = { apiKey:"AIzaSyD37Lc_tHwEkmXSHwDr6QUTNeWXGOKAftg", authDomain:"dodger-4aad1.firebaseapp.com", projectId:"dodger-4aad1", storageBucket:"dodger-4aad1.appspot.com", messagingSenderId:"148070811748", appId:"1:148070811748:web:1ed51b4872b9d9106b3771", measurementId:"G-NV3R6CEYH7" };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  signInAnonymously(auth).catch(()=>{});

  window.firebase = {
    auth, db,
    onUser(cb){ return onAuthStateChanged(auth, cb); },
    async setDisplayName(name){ if(!auth.currentUser) return; const clean=String(name||"Player").trim().slice(0,24); await updateProfile(auth.currentUser,{displayName:clean}); return clean; },
    async saveScore(score){ if(!auth.currentUser) return {ok:false,error:"Not signed in"}; try{ await addDoc(collection(db,"scores"),{uid:auth.currentUser.uid,name:auth.currentUser.displayName||auth.currentUser.email||"Player",score:Math.floor(Number(score)||0),ts:serverTimestamp()}); return {ok:true}; }catch(e){ return {ok:false,error:e.message}; } },
    async loadTop(n=20){ const qy=query(collection(db,"scores"),orderBy("score","desc"),orderBy("ts","asc"),limit(n)); const snap=await getDocs(qy); return snap.docs.map(d=>({id:d.id,...d.data()})); },
    async getOrCreateWallet(){ const u=auth.currentUser; if(!u) return 0; const ref=doc(db,"wallets",u.uid); const s=await getDoc(ref); if(!s.exists()) { await setDoc(ref,{coins:0}); return 0; } return Number(s.data()?.coins||0); },
    async addCoins(n){ const u=auth.currentUser; if(!u) return; const ref=doc(db,"wallets",u.uid); await setDoc(ref,{coins:0},{merge:true}); await updateDoc(ref,{coins:increment(n|0)}); }
  };

  const userChip=document.getElementById("userChip");
  const coinCountEl=document.getElementById("coinCount");
  const authBtn=document.getElementById("authBtn");
  const authModal=document.getElementById("authModal");
  const authClose=document.getElementById("authClose");
  const authEmail=document.getElementById("authEmail");
  const authPass=document.getElementById("authPass");
  const authMsg=document.getElementById("authMsg");
  const btnIn=document.getElementById("authSignin");
  const btnUp=document.getElementById("authSignup");
  const btnOut=document.getElementById("authSignout");

  onAuthStateChanged(auth, async (u)=>{
    if (!u){ userChip.textContent="Guest (not saved)"; coinCountEl.textContent="0"; return; }
    userChip.textContent = u.displayName ? `Signed in: ${u.displayName}` : (u.email ? `Signed in: ${u.email}` : "Signed in");
    try { coinCountEl.textContent = String(await window.firebase.getOrCreateWallet()); } catch {}
  });

  function openModal(m){ m.style.display="flex"; }
  function closeModal(m){ m.style.display="none"; }
  document.querySelectorAll(".modal").forEach(m=>{ m.addEventListener("pointerdown",(e)=>{ if(e.target===m) closeModal(m); },{passive:true}); });
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") document.querySelectorAll(".modal").forEach(m=>{ if(m.style.display==="flex") closeModal(m); }); });

  authBtn.addEventListener("pointerdown", e=>{ e.preventDefault(); openModal(authModal); });
  authClose.addEventListener("pointerdown", e=>{ e.preventDefault(); closeModal(authModal); });

  btnIn.addEventListener("pointerdown", async e=>{ e.preventDefault(); authMsg.textContent=""; try{ await signInWithEmailAndPassword(auth,authEmail.value,authPass.value); closeModal(authModal);}catch(err){ authMsg.textContent=err.message; }});
  btnUp.addEventListener("pointerdown", async e=>{ e.preventDefault(); authMsg.textContent=""; try{ const cred=await createUserWithEmailAndPassword(auth,authEmail.value,authPass.value); const def=(authEmail.value||"").split("@")[0].slice(0,24)||"Player"; await updateProfile(cred.user,{displayName:def}); closeModal(authModal);}catch(err){ authMsg.textContent=err.message; }});
  btnOut.addEventListener("pointerdown", async e=>{ e.preventDefault(); await signOut(auth); closeModal(authModal); });
</script>

<!-- Game (unchanged aside from coins calling addCoins) -->
<script>
/* your existing game code from the previous working version lives here ‚Äî
   unchanged ‚Äî so this message doesn‚Äôt get too long. If you need me to
   paste the whole thing again verbatim, say ‚Äúpaste game too‚Äù and I‚Äôll
   drop it in. */
</script>
</body>
</html>